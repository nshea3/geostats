---
title: "R Notebook"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---



```{r}
rm(list=ls())

coal_df = read.csv(file = 'dataset_Nicholas-Tony.csv')


coal_df$LQ = coal_df$LQ + 1

coal_df
```
```{r}
plot(coal_df$x, coal_df$y, cex = coal_df$Thickness/10.0)
```
```{r}
print(mean(coal_df$Thickness))
print(var(coal_df$Thickness))
```
```{r}
print(mean(coal_df$Accumulation))
print(var(coal_df$Accumulation))
```



```{r}
hist(coal_df$Thickness)
```
```{r}
hist(coal_df$Accumulation)
```

```{r}
library(RGeostats)



coal_db <- db.create(coal_df)

coal_db = db.locate(coal_db,3:4,"x")
coal_db = db.locate(coal_db,5,"z")

coal_db
plot(coal_db)
```

# 4. Conditional simulation of thickness T on the discretization grid

http://rgeostats.free.fr/html/simpgs.html

```{r}

#sim_thickness <- function(){
#}


sim_thickness <- function(indb, nsim = 1){
  indb = db.locate(indb, "Thickness", "z")
  
  Tmodel=model.create(vartype="Gaussian",range=20,sill=4,ndim=2)
  outdb = db.create(x0=c(0,0),dx=c(1,1),nx=c(200,100))
  neighb = neigh.create(ndim = 2, type = 0)
  simu <- simtub(nbtuba = 450, dbin=indb,dbout=outdb,model=Tmodel,neigh = neighb,mean = c(10), nbsimu = nsim)
  return(simu)

}

simu = sim_thickness(coal_db)

plot(simu)
plot(coal_db, add=T)
```
```{r}
hist(simu@items$Simu.Thickness.S1)
cgrid = db.create(x0=c(0,0),dx=c(10,10),nx=c(20,10))
#simu
plot(blockstat(cgrid, simu, fun='mean'))
```

# 5. Conditional simulation of LQ (lignite quality index)

Modelled as a thresholded GRF with constant proportion 0.5. 
Underlying GRF is standard ($\mu = 0$ and $\sigma^{2} = 1$) and Gaussian covariance with range 50. 

First, update the 

```{r}

props = table(coal_db[,"LQ"]) / coal_db$nsamples
props = c(0.5,0.5)
rule = rule.create(c("S", "F1", "F2"))
plot(rule, props=props, col=c("blue","yellow"), title="Lithotype Rule")
```

```{r}


sim_lq <- function(indb, nsim = 1){
  
  indb = db.locate(indb, "LQ", "z")
  props = c(0.5,0.5)
  rule = rule.create(c("S", "F1", "F2"))
  voisin = neigh.create(type=0)
  outdb = db.create(x0=c(0,0),dx=c(1,1),nx=c(200,100))
  gaus = model.create("Gaussian", range=50)
  simlq = simpgs(dbout=outdb, dbin=indb, rule=rule,props=c(0.5, 0.5), model1=gaus, neigh = voisin, nbsimu = nsim)
  return(simlq)

}

simlq = sim_lq(coal_db)

plot(simlq)
plot(db.locate(coal_db, "LQ", "z"), add = T)
```
```{r}
hist(simlq@items$SimPGS.LQ.SFac1)
```




# 6. Conditional simulation of the accumulation A 

just continue with the simulation from before

Where $LQ(x) = 0$,  $\mu = 5000$ and $\sigma^{2} = 250000$

Where $LQ(x) = 1$, $\mu = 15000$ and $\sigma^{2} = 9\times10^6$.

Both have Gaussian covariance with range 10. 

***QUESTION:*** where to set the variance? we set the mean in the simtub function. 
Does this go in the "sill" argument?

```{r}

sim_a0 <- function(indb, nsim=1){
  
  indb = db.locate(indb, "Accumulation", "z")
  coal_a0 = db.sel(indb, LQ==1)
  gaus_a0 = model.create("Gaussian", range=10, sill=250000)
  outdb = db.create(x0=c(0,0),dx=c(1,1),nx=c(200,100))
  neighb = neigh.create(ndim = 2, type = 0)
  sim =  simtub(dbin = coal_a0,dbout=outdb,model=gaus_a0,neigh = neighb,mean=5000, nbsimu = nsim)
  return(sim)
  
}


#Tmodel=model.create(vartype="Gaussian",range=20,ndim=2)

sima0 = sim_a0(coal_db)


plot(sima0, pos.legend=0)
plot(db.locate(coal_db, "Accumulation", "z"), add = T)
```
```{r}

sim_a1 <- function(indb, nsim=1){
  
  db.locate(indb, "Accumulation", "z")
  coal_a1 = db.sel(indb, LQ==2)
  coal_a1 = db.locate(coal_a1,6,"z")
  gaus_a1 = model.create("Gaussian", range=10, sill=9000000)
  outdb = db.create(x0=c(0,0),dx=c(1,1),nx=c(200,100))
  neighb = neigh.create(ndim = 2, type = 0)
  sim_a1 =  simtub(dbin = coal_a1,dbout=outdb,model=gaus_a1,neigh = neighb,mean=15000, nbsimu = nsim)
  return(sim_a1)

}

sima1 = sim_a1(coal_db)

plot(sima1,pos.legend=2)
plot(db.locate(coal_db, "Accumulation", "z"),add=T)
```
***QUESTION***: 



```{r}


```

```{r}

#Create masks/selections for the A_0 region and A_1 region
#sim_lq0_sel = db.sel(simlq, SimPGS.LQ.SFac1==1)
#sim_lq1_sel = db.sel(simlq, SimPGS.LQ.SFac1==2)
#
#cpdb = db.grid.copy(sim_lq, sim_a0, names =db.getname(sim_lq,"z",1))
#
#cpdb = db.sel(cpdb, Copy.SimPGS.LQ.SFac1==1)
#
#cpdb = db.locate(cpdb, 4, "z")

plot(cpdb)
```
```{r}
plot(sim_a0)

#Pull out vectors of simulated 
simulated_a0 = sim_a0@items$Simu.Accumulation.S1
simulated_a1 = sim_a1@items$Simu.Accumulation.S1

#Retrieve the simulated LQ index
#Turn into binary selector/mask
mask_1 = sim_lq@items$SimPGS.LQ.SFac1 - 1
#Reverse
mask_0 = 1 - mask_1

#Check - make sure the 
all(mask_0 + mask_1 == 1)

pw_map = mask_0 * simulated_a0 + mask_1 * simulated_a1
```

Made the map, now to put it back into R

```{r}

join_sims_zonal <- function(sim0, sim1, zones){
  
  mask_1 = zones - 1
  mask_0 = 1 - mask_1
  pw_map = mask_0 * sim0 + mask_1 * sim1
  return(pw_map)
  
}

simulated_a0 = sima0@items$Simu.Accumulation.S1
simulated_a1 = sima1@items$Simu.Accumulation.S1

jsim = join_sims_zonal(simulated_a0,simulated_a1,simlq@items$SimPGS.LQ.SFac1)

plot(db.locate(db.create(jsim,x0=c(0,0),dx=c(1,1),nx=c(200,100)),"jsim","z"))



```

# 7. Calorific value

Compute and plot the calorific value $C(x) = \frac{A(x)}{T(x)}$.

```{r}




cx = apwdb@items$pw_map/simu@items$Simu.Thickness.S1

cxdb = db.create(cx,x0=c(0,0),dx=c(1,1),nx=c(200,100))
cxdb = db.locate(cxdb, 4, "z")
plot(cxdb)

```
```{r}
cgrid = db.create(x0=c(0,0),dx=c(10,10),nx=c(20,10))
#simu
plot(blockstat(cgrid, cxdb, fun='mean'))

panel_q =blockstat(cgrid, cxdb, fun='mean')
```
```{r}
sel = selectivity(panel_q, cuts = seq(1000,2500,50))
```

```{r}
min(simu@items$Simu.Thickness.S1)
```
# 100 iterations 

```{r}
sthicks = sim_thickness(coal_db, nsim = 100)
slqs = sim_lq(coal_db, nsim = 100)
sima0 = sim_a0(coal_db, nsim = 100)
sima1 = sim_a1(coal_db, nsim = 100)
```
```{r}
#for (x in slqs@items){
#  print(mean(x))
#}


#The runs are stored in a list, starting at number 4 and going on for each of the simulations
#Need to 


for (idx in 4:103){
  print(mean(slqs@items[[idx]]))
}

```


```{r}

simt = sim_thickness(coal_db)

for (x in 1:100){

  #Each iteration, need to:
  #  Conditionally simulate thickness
  simt = sim_thickness(coal_db)
  #  Conditionally simulate lignite quality index
  simlq = sim_lq(coal_db)
  #  Conditionally simulate accumulations A0 and A1
  sima0 = sim_a0(coal_db)
  sima1 = sim_a1(coal_db)
  #  Stitch together the conditional simulations
  simulated_a0 = sima0@items$Simu.Accumulation.S1
  simulated_a1 = sima1@items$Simu.Accumulation.S1
  mask = simlq@items$SimPGS.LQ.SFac1
  jsim = join_sims_zonal(simulated_a0,simulated_a1,mask)
  
  cx = jsim / simt@items$Simu.Thickness.S1
  
  cxdb = db.create(cx,x0=c(0,0),dx=c(1,1),nx=c(200,100))
  cxdb = db.locate(cxdb, "cx", "z")
  
  cgrid = db.create(x0=c(0,0),dx=c(10,10),nx=c(20,10))
  
  panel_q = blockstat(cgrid, cxdb, fun='mean')
  
  print(db.stat(panel_q, fun="mean"))

}


```

